<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${post.title}">Post Detail</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQkZ4A94BOJraryswftwqFis6l53qfsqA&callback=initMap" async defer></script>
  <script th:inline="javascript">
    let map;
    let postMarker; // ì›ë˜ ë§ˆì»¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let userMarker; // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
    let distanceService; // ê±°ë¦¬ ê³„ì‚° ì„œë¹„ìŠ¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜

    function initMap() {
      const defaultLocation = { lat: 36.5, lng: 127.5 };
      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLocation,
        zoom: 7,
      });

      distanceService = new google.maps.DistanceMatrixService(); // ê±°ë¦¬ ê³„ì‚° ì„œë¹„ìŠ¤ ì´ˆê¸°í™”

      const postId = [[${post.id}]]

      $.ajax({
        url: `/api/posts/${postId}`,
        method: 'GET',
        success: function(post) {
          const location = {
            lat: post.latitude,
            lng: post.longitude
          };

          postMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: "Post Location",
            center: location,
            zoom: 20,
          });

          map.setCenter(postMarker.getPosition()); // ë§ˆì»¤ ìœ„ì¹˜ë¡œ ì¤‘ì‹¬ ì´ë™
          map.setZoom(15); // ì¤Œ ë ˆë²¨ ì¡°ì •
          // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          postMarker.addListener('click', function() {
            if (userMarker) { // ë§ˆì§€ë§‰ ë§ˆì»¤ê°€ ì•„ë‹Œ ê²½ìš°
              // ì¤Œ ë° ì„¼í„° ë³€ê²½
              map.setZoom(13); // ì›í•˜ëŠ” ì¤Œ ë ˆë²¨ë¡œ ì„¤ì •
              map.setCenter(postMarker.getPosition()); // í˜„ì¬ ë§ˆì»¤ ìœ„ì¹˜ë¡œ ì¤‘ì‹¬ ë³€ê²½
            } else  {
              getUserLocation(); // ì‚¬ìš©ì ìœ„ì¹˜ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ í˜¸ì¶œ

            }


          });
        },
        error: function() {
          alert('Failed to load post data!');
        }
      });
    }

    // URLì—ì„œ í¬ìŠ¤íŠ¸ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getPostIdFromUrl() {
      const pathSegments = window.location.pathname.split('/');
      return pathSegments[pathSegments.length - 1];
    }

    // ì‚¬ìš©ì ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {

          const userLocation = {
            lat: parseFloat(position.coords.latitude),
            lng: parseFloat(position.coords.longitude)
          };

          map.setCenter(userLocation); // ë§ˆì»¤ ìœ„ì¹˜ë¡œ ì¤‘ì‹¬ ì´ë™
          map.setZoom(7); // ì¤Œ ë ˆë²¨ ì¡°ì •
          setUserMarker(userLocation); // ì‚¬ìš©ì ë§ˆì»¤ ì„¤ì •
          calculateDistance(userLocation); // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ í˜¸ì¶œ
        }, () => {
          alert('Unable to retrieve your location. Please allow location access.');
        });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }

    // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
    function setUserMarker(userLocation) {
      if (userMarker) {
        userMarker.setMap(null); // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
      }
      userMarker = new google.maps.Marker({
        position: userLocation,
        map: map,
        title: "Your Location",
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          fillColor: '#5a6268', // ì›í•˜ëŠ” ìƒ‰ìƒìœ¼ë¡œ ë³€ê²½
          fillOpacity: 1,
          scale: 10, // í¬ê¸° ì¡°ì •
          strokeColor: '#FFFFFF',
          strokeWeight: 2
        },
      });
    }
    async function getAddress(latitude, longitude) {
      const apiKey = 'AIzaSyBQkZ4A94BOJraryswftwqFis6l53qfsqA';  // ì—¬ê¸°ì— API í‚¤ ì…ë ¥
      const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&key=${apiKey}`;

      try {
        const response = await fetch(url);  // API í˜¸ì¶œì„ ê¸°ë‹¤ë¦¼
        const data = await response.json(); // ì‘ë‹µ ë°ì´í„°ë¥¼ JSONìœ¼ë¡œ ë³€í™˜

        if (data.status === "OK") {
          const address = data.results[0].formatted_address;  // ì£¼ì†Œ ì¶”ì¶œ
          console.log("ì£¼ì†Œ:", address);
          return address;  // ì£¼ì†Œë¥¼ ë°˜í™˜
        } else {
          console.error("Geocoding API ì—ëŸ¬:", data.status);
          return null;
        }
      } catch (error) {
        console.error("API í˜¸ì¶œ ì—ëŸ¬:", error);
        return null;  // ì—ëŸ¬ ë°œìƒ ì‹œ null ë°˜í™˜
      }
    }

    async function calculateDistance(userLocation) {
      const markerLocation = {
        lat: postMarker.getPosition().lat(),
        lng: postMarker.getPosition().lng()
      };

      // ìœ„ë„ ë° ê²½ë„ ìœ íš¨ì„± ê²€ì‚¬
      if (!userLocation || !markerLocation) {
        alert('ìœ„ì¹˜ ì •ë³´ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      const line = new google.maps.Polyline({
        path: [userLocation, markerLocation], // ì„ ì„ ê·¸ë¦´ ê²½ë¡œ
        geodesic: true, // ëŒ€ì›ì„ ìœ¼ë¡œ ê·¸ë¦¬ê¸°
        strokeColor: "#FF0000", // ì„  ìƒ‰ìƒ
        strokeOpacity: 1.0, // ì„  ë¶ˆíˆ¬ëª…ë„
        strokeWeight: 2, // ì„  ë‘ê»˜
      });

      line.setMap(map); // ì„ ì„ ì§€ë„ì— ì¶”ê°€
      document.getElementById('loading').style.display = 'block';
      var origin1 = new google.maps.LatLng(userLocation);
      var origin2 = await getAddress(userLocation.lat, userLocation.lng);
      var destinationA = await getAddress(markerLocation.lat, markerLocation.lng);
      var destinationB = new google.maps.LatLng(markerLocation);

      var service = new google.maps.DistanceMatrixService();
      const c = service.getDistanceMatrix(
              {
                origins: [origin1, origin2],
                destinations: [destinationA, destinationB],
                travelMode: 'TRANSIT',
                avoidHighways: false,
                avoidTolls: false,
              }, callback);

      function callback(response, status) {
        console.log(response)
        if (status === 'OK') {
          document.getElementById('loading').style.display = 'none';
              const element = response.rows[0].elements[0];
              if (element.status === 'OK') {
                const destinationAddresses = response.destinationAddresses[0]
                const originAddresses = response.originAddresses[0]
                const distance = element.distance.text;
                const duration = element.duration.text;
                document.getElementById('originAddr').textContent = originAddresses;
                document.getElementById('destinationAddr').textContent = destinationAddresses;
                  document.getElementById('distance').textContent = distance;
                  document.getElementById('duration').textContent = duration;
              } else {
                alert(`Distance calculation failed: ${element.status}`);
                console.error('Distance calculation failed:', element);
              }
            } else {
              console.error('Error in distance matrix response:', status);
              alert('Failed to calculate distance. Please try again.');
            }
      }
    }

    function likePost() {
      const postId = [[${post.id}]]
      $.ajax({
        type: 'POST',
        url: `/api/posts/${postId}/like`,
        success: function(response) {
          // ì„±ê³µí•˜ë©´ í•´ë‹¹ ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš” ìˆ«ì(span)ë¥¼ ì—…ë°ì´íŠ¸
          let likeCountElement = document.getElementById(`like-count-${postId}`);
          let currentLikes = parseInt(likeCountElement.textContent);
          likeCountElement.textContent = currentLikes + 1; // ì¢‹ì•„ìš” ìˆ˜ë¥¼ 1 ì¦ê°€
        },
        error: function(error) {
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ì´ë©”ì¼ íŒì—… ì—´ê¸°
    function openEmailPopup() {
      document.getElementById("emailPopup").style.display = "flex";
    }

    // ì´ë©”ì¼ íŒì—… ë‹«ê¸°
    function closeEmailPopup() {
      document.getElementById("emailPopup").style.display = "none";
    }

    // ì´ë©”ì¼ ì „ì†¡ í•¨ìˆ˜
    function sendEmail() {
      const recipient = document.getElementById("recipient").value;
      const subject = document.getElementById("subject").value;
      const message = document.getElementById("message").value;
      const imagePath = document.querySelector("img").src; // ì´ë¯¸ì§€ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°

      const emailData = {
        recipient: recipient,
        subject: subject,
        message: message,
        imagePath: imagePath // ì´ë¯¸ì§€ ê²½ë¡œ ì „ë‹¬
      };

      fetch("/posts/sendEmail", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(emailData)
      })
              .then(response => response.text())
              .then(data => {
                alert(data);
                closeEmailPopup();
              })
              .catch(error => {
                console.error("Error sending email:", error);
                alert("ë©”ì¼ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
              });
    }

  </script>
  <style>
    /* ì§€ë„ ìŠ¤íƒ€ì¼ */
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
      margin-bottom: 40px;
    }
    /*íŒì—… ìŠ¤íƒ€ì¼*/
    .popup {
      position: fixed;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .popup-content {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      width: 400px; /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì¡°ì • ê°€ëŠ¥ */
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      position: relative;
      max-width: 90%; /* ë°˜ì‘í˜• ë””ìì¸ì„ ìœ„í•´ ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */
    }

    .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      color: #333;
      cursor: pointer;
    }

    h3 {
      margin-bottom: 15px;
      font-size: 22px;
      text-align: center;
      color: #333;
    }

    label {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }

    input[type="email"],
    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      margin-bottom: 15px;
    }

    textarea {
      resize: none;
    }

    .btn-success {
      background-color: #28a745;
      color: #fff;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      width: 100%;
    }

    .btn-success:hover {
      background-color: #218838;
    }

  </style>
</head>
<body>
<div class="container mt-5">
  <div class="card">
    <img th:src="${post.imagePath}" alt="Post Image" class="card-img-top">
    <div class="card-body">
      <h5 class="card-title" th:text="${post.title}"></h5>
      <p class="card-text" th:text="${post.content}"></p>
      <button id="like-btn-" class="btn btn-primary" onclick="likePost()" th:attrappend="id=${post.id}">
        ğŸ‘ Like <span id="like-count-" th:attrappend="id=${post.id}">[[${post.likes}]]</span>
      </button>
      <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn btn-warning">Edit</a>
      <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post" style="display: inline;">
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
      <!-- ì´ë©”ì¼ ì „ì†¡ ë²„íŠ¼ -->
      <button class="btn btn-info" onclick="openEmailPopup()">Send Email</button>
      <a href="/posts" class="btn btn-secondary">Back to List</a>
    </div>
  </div>


  <!-- ì´ë©”ì¼ ì „ì†¡ íŒì—… -->
  <div id="emailPopup" class="popup" style="display: none;">
    <div class="popup-content">
      <span class="close" onclick="closeEmailPopup()">&times;</span>
      <h3>ì´ë©”ì¼ ì „ì†¡</h3>
      <form id="emailForm">
        <label for="recipient">ë°›ëŠ” ì‚¬ëŒ:</label>
        <input type="email" id="recipient" name="recipient" required><br><br>

        <label for="subject">ì œëª©:</label>
        <input type="text" id="subject" name="subject" th:text="${post.title}" required><br><br>

        <label for="message">ë©”ì‹œì§€:</label>
        <textarea id="message" name="message" th:value="${post.content}" rows="4" required></textarea><br><br>

        <button type="button" class="btn btn-success" onclick="sendEmail()">ì „ì†¡</button>
      </form>
    </div>
  </div>


  <div id="loading" style="display: none; text-align: center; margin-top: 20px;">
    <div class="spinner-border" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p>ê±°ë¦¬ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...</p>
  </div>

    <div id="distance-result" class="mt-3">
      <br>ì¶œë°œì§€: <span id="originAddr"></span></br>
      <br>ë„ì°©ì§€: <span id="destinationAddr"></span></br>
        <br>ê±°ë¦¬: <span id="distance"></span></br>
        <br>ì‹œê°„: <span id="duration"></span></br>
      <span>ê±°ë¦¬ê³„ì‚°ì€ ì•„ë˜ ì§€ë„ì˜ ë§ˆì»¤ë¥¼ í´ë¦­í•˜ì„¸ìš”</span>
    </div>
  <!-- Google Maps ì¶”ê°€ -->
  <div id="map"></div>
</div>
</body>
</html>
