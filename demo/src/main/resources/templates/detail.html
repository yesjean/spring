<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${post.title}">Post Detail</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQkZ4A94BOJraryswftwqFis6l53qfsqA"></script>
  <script>
    // íŒì—… ì—´ê¸°
    function openMailPopup() {
      $('#mailPopup').show();
    }

    // íŒì—… ë‹«ê¸°
    function closeMailPopup() {
      $('#mailPopup').hide();
    }

    // ë©”ì¼ ì „ì†¡ ë¡œì§
    function sendMail() {
      var recipient = $('#recipientEmail').val();
      var subject = $('#emailSubject').val();
      var message = $('#emailMessage').val();
      var imagePath = $('#imagePath').val(); // ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ì¶”ê°€

      // ë©”ì¼ ë°œì†¡ ìš”ì²­ ì²˜ë¦¬
      $.ajax({
        type: 'POST',
        url: '/posts/sendEmail',
        contentType: 'application/json', // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
        data: JSON.stringify({
          recipient: recipient,
          subject: subject,
          message: message,
          imagePath: imagePath // ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ê°€
        }),
        success: function() {
          alert('ë©”ì¼ ì „ì†¡ ì™„ë£Œ!');
          closeMailPopup();
        },
        error: function() {
          alert('ë©”ì¼ ì „ì†¡ ì‹¤íŒ¨!');
        }
      });
    }

    // Google Maps ì´ˆê¸°í™” ë° ë§ˆì»¤ ì¶”ê°€
    function initMap() {
      const postId = getPostIdFromUrl(); // URLì—ì„œ í¬ìŠ¤íŠ¸ ID ê°€ì ¸ì˜¤ê¸°
      console.log("Post ID:", postId); // ID ì¶œë ¥

      $.ajax({
        url: `/api/posts/${postId}`, // API í˜¸ì¶œ
        method: 'GET',
        success: function(post) {
          console.log("Post Data:", post); // ê²Œì‹œë¬¼ ë°ì´í„° ì¶œë ¥
          if (!post) {
            alert('No post found for this ID!');
            return;
          }

          const location = {
            lat: post.latitude, // ìœ„ë„
            lng: post.longitude // ê²½ë„
          };

          const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: location,
          });

          new google.maps.Marker({
            position: location,
            map: map,
            title: "Post Location",
          });
        },
        error: function(xhr) {
          console.error("Error:", xhr); // ì—ëŸ¬ ì¶œë ¥
          alert('Failed to load post data!');
        }
      });
    }


    // URLì—ì„œ í¬ìŠ¤íŠ¸ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getPostIdFromUrl() {
      const pathSegments = window.location.pathname.split('/'); // URLì„ '/'ë¡œ ë‚˜ëˆ”
      return pathSegments[pathSegments.length - 1]; // ë§ˆì§€ë§‰ ë¶€ë¶„ì´ IDì¼ ê²ƒì„
    }

    function likePost() {
      const postId = getPostIdFromUrl(); // URLì—ì„œ í¬ìŠ¤íŠ¸ ID ê°€ì ¸ì˜¤ê¸°
      console.log(postId)
      $.ajax({
        type: 'POST',
        url: `/api/posts/${postId}/like`,
        success: function(response) {
          // ì„±ê³µí•˜ë©´ í•´ë‹¹ ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš” ìˆ«ì(span)ë¥¼ ì—…ë°ì´íŠ¸
          let likeCountElement = document.getElementById(`like-count`);
          let currentLikes = parseInt(likeCountElement.textContent);
          likeCountElement.textContent = currentLikes + 1; // ì¢‹ì•„ìš” ìˆ˜ë¥¼ 1 ì¦ê°€
        },
        error: function(error) {
          alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }


    window.onload = initMap; // í˜ì´ì§€ ë¡œë“œ ì‹œ initMap í˜¸ì¶œ
  </script>
  <style>
    /* íŒì—… ìŠ¤íƒ€ì¼ */
    #mailPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      padding: 20px;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    #mailPopup input, #mailPopup textarea {
      width: 100%;
      margin-bottom: 10px;
    }

    /* ì§€ë„ ìŠ¤íƒ€ì¼ */
    #map {
      width: 100%;
      height: 400px; /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ì„¤ì • ê°€ëŠ¥ */
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <div class="card">
    <img th:src="${post.imagePath}" id="imagePath" alt="Post Image" class="card-img-top">
    <div class="card-body">
      <h5 class="card-title" th:text="${post.title}"></h5>
      <p class="card-text" th:text="${post.content}"></p>
      <div class="action-buttons">
        <!-- ê²Œì‹œê¸€ ìƒì„¸ì— ìˆëŠ” ì¢‹ì•„ìš” ë²„íŠ¼ -->
        <button id="like-btn" class="btn btn-primary" onclick="likePost()">
          ğŸ‘ Like <span id="like-count">[[${post.likes}]]</span>
        </button>


        <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn btn-warning">Edit</a>
        <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
        <a href="/posts" class="btn btn-secondary">Back to List</a>
        <!-- ë©”ì¼ ì „ì†¡ íŒì—… ì—´ê¸° ë²„íŠ¼ -->
        <button type="button" class="btn btn-info" onclick="openMailPopup()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Google Maps ì¶”ê°€ -->
  <div id="map"></div>
</div>

<!-- ë©”ì¼ ì „ì†¡ íŒì—… -->
<div id="mailPopup">
  <h5>Send Email</h5>
  <input type="email" id="recipientEmail" placeholder="Recipient Email">
  <input type="text" id="emailSubject" placeholder="Email Subject">
  <textarea id="emailMessage" placeholder="Message" rows="4"></textarea>
  <button type="button" class="btn btn-primary" onclick="sendMail()">Send</button>
  <button type="button" class="btn btn-secondary" onclick="closeMailPopup()">Close</button>
</div>
</body>
</html>
