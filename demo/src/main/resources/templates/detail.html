<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${post.title}">Post Detail</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQkZ4A94BOJraryswftwqFis6l53qfsqA"></script>
  <script>
    // 팝업 열기
    function openMailPopup() {
      $('#mailPopup').show();
    }

    // 팝업 닫기
    function closeMailPopup() {
      $('#mailPopup').hide();
    }

    // 메일 전송 로직
    function sendMail() {
      var recipient = $('#recipientEmail').val();
      var subject = $('#emailSubject').val();
      var message = $('#emailMessage').val();
      var imagePath = $('#imagePath').val(); // 이미지 경로를 추가

      // 메일 발송 요청 처리
      $.ajax({
        type: 'POST',
        url: '/posts/sendEmail',
        contentType: 'application/json', // JSON 형식으로 전송
        data: JSON.stringify({
          recipient: recipient,
          subject: subject,
          message: message,
          imagePath: imagePath // 이미지 경로 추가
        }),
        success: function() {
          alert('메일 전송 완료!');
          closeMailPopup();
        },
        error: function() {
          alert('메일 전송 실패!');
        }
      });
    }

    // Google Maps 초기화 및 마커 추가
    function initMap() {
      const postId = getPostIdFromUrl(); // URL에서 포스트 ID 가져오기
      console.log("Post ID:", postId); // ID 출력

      $.ajax({
        url: `/api/posts/${postId}`, // API 호출
        method: 'GET',
        success: function(post) {
          console.log("Post Data:", post); // 게시물 데이터 출력
          if (!post) {
            alert('No post found for this ID!');
            return;
          }

          const location = {
            lat: post.latitude, // 위도
            lng: post.longitude // 경도
          };

          const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 10,
            center: location,
          });

          new google.maps.Marker({
            position: location,
            map: map,
            title: "Post Location",
          });
        },
        error: function(xhr) {
          console.error("Error:", xhr); // 에러 출력
          alert('Failed to load post data!');
        }
      });
    }


    // URL에서 포스트 ID를 가져오는 함수
    function getPostIdFromUrl() {
      const pathSegments = window.location.pathname.split('/'); // URL을 '/'로 나눔
      return pathSegments[pathSegments.length - 1]; // 마지막 부분이 ID일 것임
    }

    function likePost() {
      const postId = getPostIdFromUrl(); // URL에서 포스트 ID 가져오기
      console.log(postId)
      $.ajax({
        type: 'POST',
        url: `/api/posts/${postId}/like`,
        success: function(response) {
          // 성공하면 해당 게시글의 좋아요 숫자(span)를 업데이트
          let likeCountElement = document.getElementById(`like-count`);
          let currentLikes = parseInt(likeCountElement.textContent);
          likeCountElement.textContent = currentLikes + 1; // 좋아요 수를 1 증가
        },
        error: function(error) {
          alert('오류가 발생했습니다.');
        }
      });
    }


    window.onload = initMap; // 페이지 로드 시 initMap 호출
  </script>
  <style>
    /* 팝업 스타일 */
    #mailPopup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      padding: 20px;
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 1000;
    }
    #mailPopup input, #mailPopup textarea {
      width: 100%;
      margin-bottom: 10px;
    }

    /* 지도 스타일 */
    #map {
      width: 100%;
      height: 400px; /* 원하는 크기로 설정 가능 */
      margin-top: 20px;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <div class="card">
    <img th:src="${post.imagePath}" id="imagePath" alt="Post Image" class="card-img-top">
    <div class="card-body">
      <h5 class="card-title" th:text="${post.title}"></h5>
      <p class="card-text" th:text="${post.content}"></p>
      <div class="action-buttons">
        <!-- 게시글 상세에 있는 좋아요 버튼 -->
        <button id="like-btn" class="btn btn-primary" onclick="likePost()">
          👍 Like <span id="like-count">[[${post.likes}]]</span>
        </button>


        <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn btn-warning">Edit</a>
        <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post" style="display: inline;">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
        <a href="/posts" class="btn btn-secondary">Back to List</a>
        <!-- 메일 전송 팝업 열기 버튼 -->
        <button type="button" class="btn btn-info" onclick="openMailPopup()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- Google Maps 추가 -->
  <div id="map"></div>
</div>

<!-- 메일 전송 팝업 -->
<div id="mailPopup">
  <h5>Send Email</h5>
  <input type="email" id="recipientEmail" placeholder="Recipient Email">
  <input type="text" id="emailSubject" placeholder="Email Subject">
  <textarea id="emailMessage" placeholder="Message" rows="4"></textarea>
  <button type="button" class="btn btn-primary" onclick="sendMail()">Send</button>
  <button type="button" class="btn btn-secondary" onclick="closeMailPopup()">Close</button>
</div>
</body>
</html>
