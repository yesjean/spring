<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title th:text="${post.title}">Post Detail</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQkZ4A94BOJraryswftwqFis6l53qfsqA&callback=initMap" async defer></script>
  <script>
    let map;
    let postMarker; // 원래 마커를 저장할 변수
    let userMarker; // 사용자 위치 마커를 저장할 변수
    let distanceService; // 거리 계산 서비스를 저장할 변수

    function initMap() {
      const defaultLocation = { lat: 36.5, lng: 127.5 };
      map = new google.maps.Map(document.getElementById("map"), {
        center: defaultLocation,
        zoom: 7,
      });

      distanceService = new google.maps.DistanceMatrixService(); // 거리 계산 서비스 초기화

      const postId = getPostIdFromUrl(); // URL에서 포스트 ID 가져오기

      $.ajax({
        url: `/api/posts/${postId}`,
        method: 'GET',
        success: function(post) {
          const location = {
            lat: post.latitude,
            lng: post.longitude
          };

          postMarker = new google.maps.Marker({
            position: location,
            map: map,
            title: "Post Location",
          });

          // 마커 클릭 이벤트 추가
          postMarker.addListener('click', function() {
            getUserLocation(); // 사용자 위치 가져오는 함수 호출
          });
        },
        error: function() {
          alert('Failed to load post data!');
        }
      });
    }

    // URL에서 포스트 ID를 가져오는 함수
    function getPostIdFromUrl() {
      const pathSegments = window.location.pathname.split('/');
      return pathSegments[pathSegments.length - 1];
    }

    // 사용자 위치를 가져오는 함수
    function getUserLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          const userLocation = {
            lat: parseFloat('${post.latitude}'),
            lng: parseFloat('${post.longitude}')
          };
          setUserMarker(userLocation); // 사용자 마커 설정
          calculateDistance(userLocation); // 거리 계산 함수 호출
        }, () => {
          alert('Unable to retrieve your location. Please allow location access.');
        });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
    }

    // 사용자 위치 마커를 설정하는 함수
    function setUserMarker(userLocation) {
      if (userMarker) {
        userMarker.setMap(null); // 기존 마커 제거
      }
      userMarker = new google.maps.Marker({
        position: userLocation,
        map: map,
        title: "Your Location",
      });
      map.setCenter(userLocation); // 지도 중심을 사용자 위치로 설정
    }

    function calculateDistance(userLocation) {
      const markerLocation = {
        lat: postMarker.getPosition().lat(),
        lng: postMarker.getPosition().lng()
      };

      // 위도 및 경도 유효성 검사
      if (!userLocation || !markerLocation) {
        alert('위치 정보를 올바르게 입력해주세요.');
        return;
      }

      distanceService.getDistanceMatrix({
        origins: [userLocation],
        destinations: [markerLocation],
        travelMode: 'DRIVING',
      }, (response, status) => {
        if (status === 'OK') {
          const element = response.rows[0].elements[0];
          if (element.status === 'OK') {
            const distance = element.distance.text;
            alert(`Distance to the post location: ${distance}`);
          } else {
            alert(`Distance calculation failed: ${element.status}`);
            console.error('Distance calculation failed:', element);
          }
        } else {
          console.error('Error in distance matrix response:', status);
          alert('Failed to calculate distance. Please try again.');
        }
      });
    }


  </script>
  <style>
    /* 지도 스타일 */
    #map {
      width: 100%;
      height: 400px;
      margin-top: 20px;
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <div class="card">
    <img th:src="${post.imagePath}" alt="Post Image" class="card-img-top">
    <div class="card-body">
      <h5 class="card-title" th:text="${post.title}"></h5>
      <p class="card-text" th:text="${post.content}"></p>
      <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn btn-warning">Edit</a>
      <form th:action="@{/posts/delete/{id}(id=${post.id})}" method="post" style="display: inline;">
        <button type="submit" class="btn btn-danger">Delete</button>
      </form>
      <a href="/posts" class="btn btn-secondary">Back to List</a>
    </div>
  </div>

  <!-- Google Maps 추가 -->
  <div id="map"></div>
</div>
</body>
</html>
